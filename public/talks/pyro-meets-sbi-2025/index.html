<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Pyro Meets SBI: Unlocking Hierarchical Bayesian Inference for Complex Simulators | Jan Teusen (n√© Boelts)</title>
<meta name="keywords" content="simulation-based inference, sbi, Pyro, hierarchical Bayesian inference, probabilistic programming, EuroSciPy, decision-making, drift-diffusion model">
<meta name="description" content="Bridging simulation-based inference and probabilistic programming for hierarchical Bayesian analysis of complex simulators">
<meta name="author" content="Jan Teusen,&thinsp;Seth Axen">
<link rel="canonical" href="https://janfb.github.io/talks/pyro-meets-sbi-2025/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e690afcd5c523330d5c8b4d746eb158361600a015e99518d4d246a6ccab0cc19.css" integrity="sha256-5pCvzVxSMzDVyLTXRusVg2FgCgFemVGNTSRqbMqwzBk=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://janfb.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://janfb.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://janfb.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://janfb.github.io/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://janfb.github.io/talks/pyro-meets-sbi-2025/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="Pyro Meets SBI: Unlocking Hierarchical Bayesian Inference for Complex Simulators" />
<meta property="og:description" content="Bridging simulation-based inference and probabilistic programming for hierarchical Bayesian analysis of complex simulators" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://janfb.github.io/talks/pyro-meets-sbi-2025/" />
<meta property="og:image" content="https://janfb.github.io/figure1.png" /><meta property="article:section" content="talks" />
<meta property="article:published_time" content="2025-08-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2025-08-20T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://janfb.github.io/figure1.png" />
<meta name="twitter:title" content="Pyro Meets SBI: Unlocking Hierarchical Bayesian Inference for Complex Simulators"/>
<meta name="twitter:description" content="Bridging simulation-based inference and probabilistic programming for hierarchical Bayesian analysis of complex simulators"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Talks",
      "item": "https://janfb.github.io/talks/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Pyro Meets SBI: Unlocking Hierarchical Bayesian Inference for Complex Simulators",
      "item": "https://janfb.github.io/talks/pyro-meets-sbi-2025/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Pyro Meets SBI: Unlocking Hierarchical Bayesian Inference for Complex Simulators",
  "name": "Pyro Meets SBI: Unlocking Hierarchical Bayesian Inference for Complex Simulators",
  "description": "Bridging simulation-based inference and probabilistic programming for hierarchical Bayesian analysis of complex simulators",
  "keywords": [
    "simulation-based inference", "sbi", "Pyro", "hierarchical Bayesian inference", "probabilistic programming", "EuroSciPy", "decision-making", "drift-diffusion model"
  ],
  "articleBody": "Talk Details When: August 20, 2025, 11:40‚Äì12:00\nWhere: EuroSciPy 2025, Room 1.38 (Ground Floor)\nDuration: 20 minutes\nMaterials: Slides and Code on GitHub Abstract Hierarchical Bayesian inference is a powerful framework for analyzing structured data common in complex experimental settings, like multi-subject decision-making research. Probabilistic programming languages (PPLs) such as Pyro provide excellent tools for defining and inferring these hierarchical models, leveraging features like plate notation for concisely representing repeated structures and managing dependencies.\nHowever, a significant challenge arises when the underlying scientific model is a complex simulator with an intractable likelihood function, rendering standard PPL-based inference inapplicable. While Simulation-Based Inference (SBI) techniques can handle such simulators by learning likelihood (or posterior) approximations from simulations, they often lack native support for easily specifying and inferring complex hierarchical dependencies.\nThis talk introduces a novel approach that bridges the sbi package and Pyro, enabling effective simulation-based hierarchical Bayesian inference. We demonstrate how likelihood approximations learned via sbi can be seamlessly integrated as custom components within Pyro models. This synergistic approach combines the strengths of both methodologies:\nSBI‚Äôs ability to perform inference on intractable simulators Pyro‚Äôs expressive power and efficiency in handling complex hierarchical structures Key Innovation The integration of SBI-learned likelihoods into Pyro models allows for hierarchical Bayesian analysis of simulation-based models. This bridges two powerful paradigms:\nThe Challenge Traditional PPLs: Require tractable likelihood functions Standard SBI: Limited support for hierarchical structures Real-world problems: Often have both intractable likelihoods AND hierarchical dependencies Our Solution We show how to:\nLearn likelihood approximations using the sbi package Integrate these approximations as custom distributions in Pyro Leverage Pyro‚Äôs infrastructure for efficient hierarchical inference Maintain the full expressiveness of both frameworks Case Study: The Cookie Factory Problem üç™ We illustrate the methodology using an accessible example: a cookie factory with 5 locations producing chocolate chip cookies. This example demonstrates:\nThe Problem Setup Data: Chocolate chip counts from 30 cookies at each of 5 factory locations Challenge: Locations follow the same recipe but may vary in execution Goal: Understand both global patterns and location-specific variations Three Modeling Approaches Pooled Model: All locations identical (ignores differences) Unpooled Model: Each location independent (no information sharing) Hierarchical Model: Locations are different but related (optimal balance) The hierarchical approach demonstrates the power of partial pooling and shrinkage effects, where extreme estimates are pulled toward the global mean.\nReal-World Application: Drift-Diffusion Model While the talk focused on the cookie example for clarity, the approach extends to complex cognitive models like the Drift-Diffusion Model (DDM) for decision-making, where analytical likelihoods are intractable\nTechnical Implementation The implementation leverages recent developments in the sbi package that facilitate this workflow:\n# Step 1: Train neural likelihood estimator with sbi from sbi.inference import NLE nle = NLE().append_simulations(theta, x) estimator = nle.train() # Step 2: Integrate into Pyro hierarchical model def sbi_pyro_model(locations, chips=None): # Hyperpriors - global parameters mu = pyro.sample(\"mu\", dist.Gamma(2, 0.2)) sigma = pyro.sample(\"sigma\", dist.Exponential(1)) # Location-specific parameters with pyro.plate(\"location\", n_locations): lam = pyro.sample(\"lam\", dist.Gamma(mu**2/sigma**2, mu/sigma**2)) # Use SBI-learned likelihood wrapped for Pyro with pyro.plate(\"data\", len(chips)): pyro.sample(\"obs\", SBItoPyro(estimator, lam[locations]), obs=chips) The SBItoPyro wrapper is a lightweight class (~150 lines) that handles shape conversions between sbi and Pyro\nImpact and Applications This integration significantly expands the scope of rigorous Bayesian inference, opening new possibilities for analyzing complex, simulation-based models across various scientific disciplines:\nNeuroscience: Hierarchical models of neural circuits Psychology: Multi-subject cognitive models Epidemiology: Population-level disease models Economics: Agent-based models with group structure Collaboration \u0026 Acknowledgments Presentation by: Jan Teusen\nPyro-SBI Bridge Implementation: Seth Axen (developed during SBI Hackathon 2025)\nCookie Factory Example: Adapted from Juan Camilo Orduz‚Äôs blog post This work represents a collaborative effort to make advanced hierarchical modeling accessible for simulator-based research, combining theoretical innovation with practical software development.\nResources üìä Slides and Code üì¶ sbi Package üî• Pyro Documentation üé• EuroSciPy 2025 Session This talk demonstrates how bridging simulation-based inference and probabilistic programming enables powerful new workflows for hierarchical Bayesian analysis of complex scientific models.\n",
  "wordCount" : "652",
  "inLanguage": "en",
  "image":"https://janfb.github.io/figure1.png","datePublished": "2025-08-20T00:00:00Z",
  "dateModified": "2025-08-20T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "Jan Teusen"
  }, {
    "@type": "Person",
    "name": "Seth Axen"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://janfb.github.io/talks/pyro-meets-sbi-2025/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jan Teusen (n√© Boelts)",
    "logo": {
      "@type": "ImageObject",
      "url": "https://janfb.github.io/favicon.ico"
    }
  }
}
</script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" integrity="sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" integrity="sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous"
  onload="renderMathInElement(document.body);"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: "\\begin{equation}", right: "\\end{equation}", display: true},
            {left: "\\begin{equation*}", right: "\\end{equation*}", display: true},
            {left: "\\begin{align}", right: "\\end{align}", display: true},
            {left: "\\begin{align*}", right: "\\end{align*}", display: true},
            {left: "\\begin{alignat}", right: "\\end{alignat}", display: true},
            {left: "\\begin{gather}", right: "\\end{gather}", display: true},
            {left: "\\begin{CD}", right: "\\end{CD}", display: true},
          ],
          throwOnError : false
        });
    });
</script>
 


</head>

<body class="" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://janfb.github.io/" accesskey="h" title="Jan Boelts (Teusen)">
                <img src="https://janfb.github.io/favicon.ico" alt="" aria-label="logo"
                    height="18"
                    width="18">Jan Boelts (Teusen)</a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://janfb.github.io/papers/" title="Papers">
                    <span>Papers</span>
                </a>
            </li>
            <li>
                <a href="https://janfb.github.io/software/" title="Software">
                    <span>Software</span>
                </a>
            </li>
            <li>
                <a href="https://janfb.github.io/talks/" title="Talks">
                    <span>Talks</span>
                </a>
            </li>
            <li>
                <a href="https://janfb.github.io/courses/" title="Teaching">
                    <span>Teaching</span>
                </a>
            </li>
            <li>
                <a href="https://transferlab.ai/authors/jan-teusen/" title="Blog">
                    <span>Blog</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Pyro Meets SBI: Unlocking Hierarchical Bayesian Inference for Complex Simulators
    </h1>
    <div class="post-meta"><span title='2025-08-20 00:00:00 +0000 UTC'>August 2025</span>&nbsp;&middot;&nbsp;Jan Teusen,&thinsp;Seth Axen&nbsp;&middot;&nbsp;<a href="https://pretalx.com/euroscipy-2025/talk/KCYYTF/" rel="noopener noreferrer" target="_blank">EuroSciPy 2025</a>

</div>
  </header> 
  <div class="post-content"><h2 id="talk-details">Talk Details</h2>
<p><strong>When:</strong> August 20, 2025, 11:40‚Äì12:00<br>
<strong>Where:</strong> EuroSciPy 2025, Room 1.38 (Ground Floor)<br>
<strong>Duration:</strong> 20 minutes<br>
<strong>Materials:</strong> <a href="https://github.com/janfb/pyro-meets-sbi" target="_blank">Slides and Code on GitHub</a>
</p>
<h2 id="abstract">Abstract</h2>
<p>Hierarchical Bayesian inference is a powerful framework for analyzing structured data common in complex experimental settings, like multi-subject decision-making research. Probabilistic programming languages (PPLs) such as Pyro provide excellent tools for defining and inferring these hierarchical models, leveraging features like plate notation for concisely representing repeated structures and managing dependencies.</p>
<p>However, a significant challenge arises when the underlying scientific model is a complex simulator with an intractable likelihood function, rendering standard PPL-based inference inapplicable. While Simulation-Based Inference (SBI) techniques can handle such simulators by learning likelihood (or posterior) approximations from simulations, they often lack native support for easily specifying and inferring complex hierarchical dependencies.</p>
<p>This talk introduces a novel approach that bridges the <strong>sbi</strong> package and <strong>Pyro</strong>, enabling effective simulation-based hierarchical Bayesian inference. We demonstrate how likelihood approximations learned via sbi can be seamlessly integrated as custom components within Pyro models. This synergistic approach combines the strengths of both methodologies:</p>
<ul>
<li><strong>SBI&rsquo;s ability</strong> to perform inference on intractable simulators</li>
<li><strong>Pyro&rsquo;s expressive power</strong> and efficiency in handling complex hierarchical structures</li>
</ul>
<h2 id="key-innovation">Key Innovation</h2>
<p>The integration of SBI-learned likelihoods into Pyro models allows for hierarchical Bayesian analysis of simulation-based models. This bridges two powerful paradigms:</p>
<h3 id="the-challenge">The Challenge</h3>
<ul>
<li><strong>Traditional PPLs</strong>: Require tractable likelihood functions</li>
<li><strong>Standard SBI</strong>: Limited support for hierarchical structures</li>
<li><strong>Real-world problems</strong>: Often have both intractable likelihoods AND hierarchical dependencies</li>
</ul>
<h3 id="our-solution">Our Solution</h3>
<p>We show how to:</p>
<ol>
<li>Learn likelihood approximations using the sbi package</li>
<li>Integrate these approximations as custom distributions in Pyro</li>
<li>Leverage Pyro&rsquo;s infrastructure for efficient hierarchical inference</li>
<li>Maintain the full expressiveness of both frameworks</li>
</ol>
<h2 id="case-study-the-cookie-factory-problem-">Case Study: The Cookie Factory Problem üç™</h2>
<p>We illustrate the methodology using an accessible example: a cookie factory with 5 locations producing chocolate chip cookies. This example demonstrates:</p>
<h3 id="the-problem-setup">The Problem Setup</h3>
<ul>
<li><strong>Data</strong>: Chocolate chip counts from 30 cookies at each of 5 factory locations</li>
<li><strong>Challenge</strong>: Locations follow the same recipe but may vary in execution</li>
<li><strong>Goal</strong>: Understand both global patterns and location-specific variations</li>
</ul>
<h3 id="three-modeling-approaches">Three Modeling Approaches</h3>
<ol>
<li><strong>Pooled Model</strong>: All locations identical (ignores differences)</li>
<li><strong>Unpooled Model</strong>: Each location independent (no information sharing)</li>
<li><strong>Hierarchical Model</strong>: Locations are different but related (optimal balance)</li>
</ol>
<p>The hierarchical approach demonstrates the power of partial pooling and shrinkage effects, where extreme estimates are pulled toward the global mean.</p>
<h3 id="real-world-application-drift-diffusion-model">Real-World Application: Drift-Diffusion Model</h3>
<p>While the talk focused on the cookie example for clarity, the approach extends to complex cognitive models like the Drift-Diffusion Model (DDM) for decision-making, where analytical likelihoods are intractable</p>
<h2 id="technical-implementation">Technical Implementation</h2>
<p>The implementation leverages recent developments in the sbi package that facilitate this workflow:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#aaa;font-style:italic"># Step 1: Train neural likelihood estimator with sbi</span>
</span></span><span style="display:flex;"><span><span style="color:#00a">from</span> <span style="color:#0aa;text-decoration:underline">sbi.inference</span> <span style="color:#00a">import</span> NLE
</span></span><span style="display:flex;"><span>nle = NLE().append_simulations(theta, x)
</span></span><span style="display:flex;"><span>estimator = nle.train()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#aaa;font-style:italic"># Step 2: Integrate into Pyro hierarchical model</span>
</span></span><span style="display:flex;"><span><span style="color:#00a">def</span> <span style="color:#0a0">sbi_pyro_model</span>(locations, chips=<span style="color:#00a">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#aaa;font-style:italic"># Hyperpriors - global parameters</span>
</span></span><span style="display:flex;"><span>    mu = pyro.sample(<span style="color:#a50">&#34;mu&#34;</span>, dist.Gamma(<span style="color:#099">2</span>, <span style="color:#099">0.2</span>))
</span></span><span style="display:flex;"><span>    sigma = pyro.sample(<span style="color:#a50">&#34;sigma&#34;</span>, dist.Exponential(<span style="color:#099">1</span>))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#aaa;font-style:italic"># Location-specific parameters</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a">with</span> pyro.plate(<span style="color:#a50">&#34;location&#34;</span>, n_locations):
</span></span><span style="display:flex;"><span>        lam = pyro.sample(<span style="color:#a50">&#34;lam&#34;</span>, 
</span></span><span style="display:flex;"><span>            dist.Gamma(mu**<span style="color:#099">2</span>/sigma**<span style="color:#099">2</span>, mu/sigma**<span style="color:#099">2</span>))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#aaa;font-style:italic"># Use SBI-learned likelihood wrapped for Pyro</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a">with</span> pyro.plate(<span style="color:#a50">&#34;data&#34;</span>, <span style="color:#0aa">len</span>(chips)):
</span></span><span style="display:flex;"><span>        pyro.sample(<span style="color:#a50">&#34;obs&#34;</span>, 
</span></span><span style="display:flex;"><span>            SBItoPyro(estimator, lam[locations]), 
</span></span><span style="display:flex;"><span>            obs=chips)
</span></span></code></pre></div><p>The <code>SBItoPyro</code> wrapper is a lightweight class (~150 lines) that handles shape conversions between sbi and Pyro</p>
<h2 id="impact-and-applications">Impact and Applications</h2>
<p>This integration significantly expands the scope of rigorous Bayesian inference, opening new possibilities for analyzing complex, simulation-based models across various scientific disciplines:</p>
<ul>
<li><strong>Neuroscience</strong>: Hierarchical models of neural circuits</li>
<li><strong>Psychology</strong>: Multi-subject cognitive models</li>
<li><strong>Epidemiology</strong>: Population-level disease models</li>
<li><strong>Economics</strong>: Agent-based models with group structure</li>
</ul>
<h2 id="collaboration--acknowledgments">Collaboration &amp; Acknowledgments</h2>
<p><strong>Presentation by:</strong> Jan Teusen<br>
<strong>Pyro-SBI Bridge Implementation:</strong> Seth Axen (developed during SBI Hackathon 2025)<br>
<strong>Cookie Factory Example:</strong> Adapted from Juan Camilo Orduz&rsquo;s <a href="https://juanitorduz.github.io/cookies_example_numpyro/" target="_blank">blog post</a>
</p>
<p>This work represents a collaborative effort to make advanced hierarchical modeling accessible for simulator-based research, combining theoretical innovation with practical software development.</p>
<h2 id="resources">Resources</h2>
<ul>
<li>üìä <a href="https://github.com/janfb/pyro-meets-sbi" target="_blank">Slides and Code</a>
</li>
<li>üì¶ <a href="https://github.com/sbi-dev/sbi" target="_blank">sbi Package</a>
</li>
<li>üî• <a href="https://pyro.ai" target="_blank">Pyro Documentation</a>
</li>
<li>üé• <a href="https://pretalx.com/euroscipy-2025/talk/KCYYTF/" target="_blank">EuroSciPy 2025 Session</a>
</li>
</ul>
<hr>
<p><em>This talk demonstrates how bridging simulation-based inference and probabilistic programming enables powerful new workflows for hierarchical Bayesian analysis of complex scientific models.</em></p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://janfb.github.io/tags/simulation-based-inference/">Simulation-Based Inference</a></li>
      <li><a href="https://janfb.github.io/tags/sbi/">SBI</a></li>
      <li><a href="https://janfb.github.io/tags/pyro/">Pyro</a></li>
      <li><a href="https://janfb.github.io/tags/hierarchical-bayesian-inference/">Hierarchical Bayesian Inference</a></li>
      <li><a href="https://janfb.github.io/tags/probabilistic-programming/">Probabilistic Programming</a></li>
      <li><a href="https://janfb.github.io/tags/euroscipy/">EuroSciPy</a></li>
      <li><a href="https://janfb.github.io/tags/decision-making/">Decision-Making</a></li>
      <li><a href="https://janfb.github.io/tags/drift-diffusion-model/">Drift-Diffusion Model</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="https://janfb.github.io/">Jan Teusen (n√© Boelts)</a></span> ¬∑     
    <span>
    Powered by 
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/pmichaillat/hugo-website/" rel="noopener" target="_blank">a modified version</a>
         of 
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>
</html>
